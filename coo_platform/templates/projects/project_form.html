{% extends 'base.html' %}
{% load crispy_forms_tags %}

{% block title %}{% if object %}Edit Project{% else %}New Project{% endif %} - COO Platform{% endblock %}

{% block breadcrumbs %}
{{ block.super }}
<li class="breadcrumb-item"><a href="{% url 'projects:list' %}">Projects</a></li>
<li class="breadcrumb-item active">{% if object %}Edit{% else %}New{% endif %}</li>
{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-lg-8">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    {% if object %}
                        <i class="fas fa-edit me-2"></i>Edit Project: {{ object.name }}
                    {% else %}
                        <i class="fas fa-plus me-2"></i>Create New Project
                    {% endif %}
                </h5>
            </div>
            
            <div class="card-body">
                <form method="post" enctype="multipart/form-data">
                    {% csrf_token %}
                    
                    <div class="row">
                        <div class="col-md-8">
                            <div class="mb-3">
                                <label for="{{ form.name.id_for_label }}" class="form-label">Project Name *</label>
                                {{ form.name }}
                                {% if form.name.errors %}
                                <div class="invalid-feedback d-block">
                                    {{ form.name.errors }}
                                </div>
                                {% endif %}
                            </div>
                        </div>
                        
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label for="{{ form.priority.id_for_label }}" class="form-label">Priority</label>
                                {{ form.priority }}
                            </div>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="{{ form.description.id_for_label }}" class="form-label">Description</label>
                        {{ form.description }}
                        <div class="form-text">Provide a detailed description of the project goals and scope.</div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="{{ form.category_id.id_for_label }}" class="form-label">Category</label>
                                {{ form.category_id }}
                            </div>
                        </div>
                        
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="{{ form.status.id_for_label }}" class="form-label">Status</label>
                                {{ form.status }}
                            </div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="{{ form.start_date.id_for_label }}" class="form-label">Start Date</label>
                                {{ form.start_date }}
                            </div>
                        </div>
                        
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="{{ form.target_end_date.id_for_label }}" class="form-label">Target End Date</label>
                                {{ form.target_end_date }}
                            </div>
                        </div>
                    </div>
                    
                    {% if object %}
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="{{ form.progress_percentage.id_for_label }}" class="form-label">Progress (%)</label>
                                {{ form.progress_percentage }}
                                <div class="form-text">Current project completion percentage (0-100).</div>
                            </div>
                        </div>
                        
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="{{ form.actual_end_date.id_for_label }}" class="form-label">Actual End Date</label>
                                {{ form.actual_end_date }}
                                <div class="form-text">Set when project is completed.</div>
                            </div>
                        </div>
                    </div>
                    {% endif %}
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="{{ form.budget_allocated.id_for_label }}" class="form-label">Budget Allocated</label>
                                <div class="input-group">
                                    <span class="input-group-text">$</span>
                                    {{ form.budget_allocated }}
                                </div>
                            </div>
                        </div>
                        
                        {% if object %}
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="{{ form.budget_spent.id_for_label }}" class="form-label">Budget Spent</label>
                                <div class="input-group">
                                    <span class="input-group-text">$</span>
                                    {{ form.budget_spent }}
                                </div>
                            </div>
                        </div>
                        {% endif %}
                    </div>
                    
                    <div class="mb-3">
                        <label for="{{ form.project_manager_id.id_for_label }}" class="form-label">Project Manager</label>
                        {{ form.project_manager_id }}
                        <div class="form-text">Select the person responsible for managing this project.</div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="{{ form.tags.id_for_label }}" class="form-label">Tags</label>
                        {{ form.tags }}
                        <div class="form-text">Enter tags separated by commas (e.g., "web, frontend, urgent").</div>
                    </div>
                    
                    <div class="d-flex justify-content-between">
                        <a href="{% if object %}{% url 'projects:detail' object.pk %}{% else %}{% url 'projects:list' %}{% endif %}" 
                           class="btn btn-outline-secondary">
                            <i class="fas fa-times me-1"></i>Cancel
                        </a>
                        
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-save me-1"></i>
                            {% if object %}Update Project{% else %}Create Project{% endif %}
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Auto-generate slug from name (if needed)
    const nameField = document.getElementById('id_name');
    const descriptionField = document.getElementById('id_description');
    
    // Auto-resize textarea
    function autoResize(textarea) {
        textarea.style.height = 'auto';
        textarea.style.height = textarea.scrollHeight + 'px';
    }
    
    if (descriptionField) {
        descriptionField.addEventListener('input', function() {
            autoResize(this);
        });
        autoResize(descriptionField);
    }
    
    // Date validation
    const startDateField = document.getElementById('id_start_date');
    const endDateField = document.getElementById('id_target_end_date');
    
    function validateDates() {
        if (startDateField.value && endDateField.value) {
            const startDate = new Date(startDateField.value);
            const endDate = new Date(endDateField.value);
            
            if (startDate > endDate) {
                endDateField.setCustomValidity('End date must be after start date');
            } else {
                endDateField.setCustomValidity('');
            }
        }
    }
    
    if (startDateField && endDateField) {
        startDateField.addEventListener('change', validateDates);
        endDateField.addEventListener('change', validateDates);
    }
    
    // Progress validation
    const progressField = document.getElementById('id_progress_percentage');
    if (progressField) {
        progressField.addEventListener('input', function() {
            const value = parseInt(this.value);
            if (value < 0 || value > 100) {
                this.setCustomValidity('Progress must be between 0 and 100');
            } else {
                this.setCustomValidity('');
            }
        });
    }
});
</script>
{% endblock %}
